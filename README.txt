مشروع: Election Excel API v3 (High Performance Edition)

هذه النسخة v3 هي نسخة عالية الأداء من الـ API:
- تعتمد على ملف Excel كقاعدة بيانات للأسماء.
- تبني Index في الذاكرة باستخدام Fuse.js لعمل Fuzzy Search سريع.
- تدعم الأخطاء الإملائية البسيطة في الأسماء.
- ترجع أقرب النتائج مرتبة حسب درجة التطابق.
- تستخدم Cache للطلبات المتكررة لتخفيف الضغط.

=====================================
١) المتطلبات
=====================================
- تثبيت Node.js (يفضّل إصدار LTS مثل 20.x)
  يمكن تنزيله من: https://nodejs.org

بعد التثبيت، تأكد أن الأوامر تعمل:
  node -v
  npm -v

=====================================
٢) إعداد ملف Excel
=====================================
- داخل مجلد "data" ضع ملف Excel باسم:
  db.xlsx

- مثال للأعمدة:
  ID
  مركز/ قسم/شرطة
  مقر اللجنة
  عنوان اللجنة
  رقم اللجنة الفرعية
  الرقم في الكشف
  الأسم

- السكربت يحاول تلقائيًا اكتشاف عمود الاسم من خلال رؤوس الأعمدة:
  "الأسم" أو "الاسم" أو "اسم" أو "name"

=====================================
٣) تشغيل المشروع
=====================================
من داخل مجلد المشروع (حيث يوجد server.js و package.json):

  npm install
  npm start

سيفتح السيرفر على:
  http://localhost:3000

يمكن تغيير:
- المنفذ عبر المتغير PORT
- مسار ملف Excel عبر EXCEL_PATH
- مفتاح الـ API عبر API_KEY

=====================================
٤) تجربة الاستعلام
=====================================
استخدم أي أداة (Postman / PowerShell / curl) لنداء:

POST http://localhost:3000/query
Headers:
  Content-Type: application/json
  x-api-key: supersecretkey   (أو غيّرها من متغير البيئة API_KEY)

Body (JSON) بسيط:

  {
    "name": "خالد محمد فاروق بسيونى"
  }

أو مع تحديد عدد النتائج المطلوبة (أقصى 50):

  {
    "name": "خالد محمد فاروق بسيونى",
    "limit": 5
  }

النتيجة ستكون بالشكل التقريبي:

  {
    "ok": true,
    "name_column": "الأسم",
    "total_matches": 12,
    "count": 5,
    "results": [
      {
        "__score": 0.97,   // درجة التطابق (من 0 إلى 1، الأعلى = أفضل)
        "__id": 123,       // معرف داخلي للصف
        "ID": 1,
        "مركز/ قسم/شرطة": "البساتين",
        "مقر اللجنة": "مدرسة المساكن الابتدائيه",
        "عنوان اللجنة": "مساكن اطلس",
        "رقم اللجنة الفرعية": 1,
        "الرقم في الكشف": 1,
        "الأسم": "خالد محمد فاروق بسيونى",
        "searchName": "خالد محمد فاروق بسيوني" (اسم مُطَبَّع للبحث - يمكن تجاهله في الكلاينت)
      },
      ...
    ]
  }

=====================================
٥) ما الفرق بين v2 و v3؟
=====================================
- v2:
  - تعتمد على خوارزمية Levenshtein اليدوية لكل كلمة في كل سجل.
  - مناسبة لعدد طلبات متوسط وعدد سجلات صغير/متوسط.
  - أكثر استهلاكًا للمعالج تحت الضغط العالي.

- v3:
  - تستخدم Fuse.js لبناء Index داخلي للأسماء (Fuzzy Search سريع).
  - البحث يتم على Index بدلاً من مسح كامل الأسماء brute-force.
  - يوجد Cache للطلبات المتكررة لمدة 60 ثانية.
  - أفضل في الحمل العالي (عدد طلبات أكبر في الثانية) مع نفس العتاد.

=====================================
٦) مميزات v3 بالتفصيل
=====================================
- استخدام ملف Excel كقاعدة بيانات محلية.
- اكتشاف عمود الاسم تلقائيًا من رؤوس الأعمدة.
- تطبيع نص عربي متقدم:
  - إزالة التشكيل.
  - إزالة علامات الاتجاه (RLM / LRM ...).
  - توحيد الألف (أ/إ/آ/ا) والـ ياء/ألف مقصورة (ي/ى).
  - توحيد بعض حالات الهمزة.
  - تنظيف الرموز الغريبة وتوحيد المسافات.
- بناء حقل "searchName" لكل سجل (اسم مُطَبَّع) للاستخدام في البحث.
- بناء Index في الذاكرة باستخدام Fuse.js على الحقل searchName.
- دعم الأخطاء الإملائية البسيطة والاختلافات الطفيفة في كتابة الاسم.
- ترتيب النتائج تنازليًا حسب درجة التطابق.
- إرجاع أقرب N نتائج (افتراضي 5) مع إمكانية تغيير N حتى 50.
- إعادة الصف كاملًا كما هو من Excel (كل الأعمدة بنفس مسمياتها الأصلية).
- إضافة حقل "__score" في كل نتيجة يوضح قوة التطابق (من 0 إلى 1).
- Cache لنتائج البحث حسب:
  - الاسم بعد التطبيع
  - عدد النتائج المطلوبة (limit)
- تسجيل كل الاستعلامات والأخطاء في log.txt.
- حماية بسيطة عبر x-api-key يمكن ضبطها من متغيرات البيئة.

=====================================
٧) ملاحظات عن الأداء
=====================================
- أداء v3 أفضل بكثير من النسخ اليدوية (Levenshtein brute force)، خاصة مع:
  - آلاف الأسماء في ملف Excel.
  - مئات أو آلاف الطلبات في الدقيقة.
- مع ذلك، الأداء النهائي يعتمد على:
  - حجم ملف Excel.
  - عتاد السيرفر (CPU / RAM).
  - عدد عمليات Node.js العاملة (يمكن تشغيل أكثر من عملية خلف Nginx أو Load Balancer).
